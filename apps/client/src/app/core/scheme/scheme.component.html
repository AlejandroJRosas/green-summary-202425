<main class="flex flex-column p-4">
  <header>
    <h2>Indicadores / Categorías / Criterios</h2>
  </header>
  <section class="flex flex-column">
    <div class="flex flex-row justify-content-between align-items-center">
      <h3>Indicadores ({{ totalItems }})</h3>
      <p-button
        (click)="showDialogCreateIndicator()"
        styleClass="bg-primary border-primary mr-4"
        label="Crear"
        icon="pi pi-plus"
        size="small"
      />
    </div>

    @for (scheme of schemes; track $index) {
      <p-panel
        expandIcon="pi pi-chevron-down"
        collapseIcon="pi pi-chevron-right"
        [toggleable]="true"
        collapsed="true"
        iconPos="start"
      >
        <ng-template pTemplate="header">
          <section
            class="flex flex-row justify-content-between align-items-center w-full"
          >
            <h2 class="text-xl">
              {{ scheme.index }}. {{ scheme.name }} ({{ scheme.alias }})
            </h2>
            <div class="flex flex-row gap-1">
              <button
                class="p-panel-header-icon p-link mr-2"
                (click)="
                  showDialogEditIndicator(
                    scheme.index,
                    scheme.name,
                    scheme.alias,
                    scheme.helpText
                  )
                "
              >
                <span
                  class="pi pi-pencil"
                  style="
                    color: #22c55e;
                    border: solid 1.5px #22c55e;
                    border-radius: 100%;
                    padding: 7px;
                  "
                ></span>
              </button>
              <button
                class="p-panel-header-icon p-link mr-2"
                (click)="
                  confirmationDeleteIndicator($event, scheme.index, scheme.name)
                "
              >
                <span
                  class="pi pi-trash"
                  style="
                    color: #ef4444;
                    border: solid 1.5px #ef4444;
                    border-radius: 100%;
                    padding: 7px;
                  "
                ></span>
              </button>
            </div>
          </section>
        </ng-template>
        <p class="m-0 pb-3">{{ scheme.helpText }}</p>
        <p-panel
          expandIcon="pi pi-chevron-down"
          collapseIcon="pi pi-chevron-right"
          [toggleable]="true"
          collapsed="true"
          iconPos="start"
        >
          <ng-template pTemplate="header">
            <section
              class="flex flex-row justify-content-between align-items-center w-full"
            >
              <h3 class="text-lg">
                Categorías ({{ scheme.categories.length }})
              </h3>
              <button
                class="p-panel-header-icon p-link mr-2"
                (click)="showCreateCategory = true"
              >
                <span
                  class="pi pi-plus"
                  style="
                    color: #3b82f6;
                    border: solid 1.5px #3b82f6;
                    border-radius: 100%;
                    padding: 6px;
                  "
                ></span>
              </button>
            </section>
          </ng-template>
          @for (category of scheme.categories; track category) {
            <category-form
              [category]="category"
              [indicatorIndex]="scheme.index"
              [visibleCreate]="showCreateCategory"
              [visibleEdit]="showEditCategory"
            ></category-form>
            <div class="flex justify-content-between align-items-center">
              <h3>{{ category.name }}</h3>
              <div>
                <button class="p-panel-header-icon p-link mr-2">
                  <span
                    class="pi pi-pencil"
                    (click)="this.categoryComponent.showDialogEdit()"
                    style="
                      color: #22c55e;
                      border: solid 1.5px #22c55e;
                      border-radius: 100%;
                      padding: 8px;
                    "
                  ></span>
                </button>
                <button
                  class="p-panel-header-icon p-link mr-2"
                  (click)="
                    confirmationDeleteCategory(
                      $event,
                      category.id,
                      category.name
                    )
                  "
                >
                  <span
                    class="pi pi-trash"
                    style="
                      color: #ef4444;
                      border: solid 1.5px #ef4444;
                      border-radius: 100%;
                      padding: 8px;
                    "
                  ></span>
                </button>
              </div>
            </div>
            <p>{{ category.helpText }}</p>
          }
        </p-panel>
        <p-panel
          expandIcon="pi pi-chevron-down"
          collapseIcon="pi pi-chevron-right"
          [toggleable]="true"
          collapsed="true"
          iconPos="start"
        >
          <ng-template pTemplate="header">
            <section
              class="flex flex-row justify-content-between align-items-center w-full"
            >
              <h3 class="text-lg">Criterios ({{ scheme.criterias.length }})</h3>
              <button class="p-panel-header-icon p-link mr-2">
                <span
                  class="pi pi-plus"
                  style="
                    color: #3b82f6;
                    border: solid 1.5px #3b82f6;
                    border-radius: 100%;
                    padding: 6px;
                  "
                ></span>
              </button>
            </section>
          </ng-template>
          @for (criteria of scheme.criterias; track criteria) {
            <div class="flex justify-content-between align-items-center">
              <h3>
                {{ scheme.index }}.{{ criteria.subIndex }}.
                {{ criteria.name }} ({{ criteria.alias }})
              </h3>
              <div>
                <button class="p-panel-header-icon p-link mr-2">
                  <span
                    class="pi pi-pencil"
                    style="
                      color: #22c55e;
                      border: solid 1.5px #22c55e;
                      border-radius: 100%;
                      padding: 8px;
                    "
                  ></span>
                </button>
                <button
                  class="p-panel-header-icon p-link mr-2"
                  (click)="
                    confirmationDeleteCriteria(
                      $event,
                      criteria.id,
                      criteria.name
                    )
                  "
                >
                  <span
                    class="pi pi-trash"
                    style="
                      color: #ef4444;
                      border: solid 1.5px #ef4444;
                      border-radius: 100%;
                      padding: 8px;
                    "
                  ></span>
                </button>
              </div>
            </div>
            <p>{{ criteria.helpText }}</p>
          }
        </p-panel>
      </p-panel>
    }
  </section>
  <p-dialog
    header="Crear Indicador"
    [modal]="true"
    [(visible)]="visibleCreateIndicator"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '30rem' }"
    (onHide)="closeDialogIndicator()"
  >
    <form [formGroup]="formGroup">
      <div class="flex flex-column gap-3">
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Índice
            <input
              pInputText
              name="index"
              class="w-full"
              type="number"
              formControlName="index"
              (input)="errorsUpdate('index')"
              (blur)="errorsUpdate('index')"
            />
          </label>
          <small class="p-error">{{ errors.index }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Nombre
            <input
              pInputText
              name="name"
              class="w-full"
              type="text"
              formControlName="name"
              (input)="errorsUpdate('name')"
              (blur)="errorsUpdate('name')"
            />
          </label>
          <small class="p-error">{{ errors.name }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Alias en español
            <input
              pInputText
              name="alias"
              class="w-full"
              type="text"
              formControlName="alias"
              (input)="errorsUpdate('alias')"
              (blur)="errorsUpdate('alias')"
            />
          </label>
          <small class="p-error">{{ errors.alias }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Mensaje de ayuda
            <textarea
              pInputTextarea
              rows="5"
              cols="40"
              formControlName="helpText"
              [required]="true"
              (input)="errorsUpdate('helpText')"
              (blur)="errorsUpdate('helpText')"
            ></textarea>
          </label>
          <small class="p-error">{{ errors.helpText }}</small>
        </div>
      </div>
      <footer class="flex justify-content-end gap-2 mt-4">
        <p-button
          label="Cancelar"
          size="small"
          icon="pi pi-times"
          [outlined]="true"
          severity="danger"
          (click)="visibleCreateIndicator = false"
        />
        <p-button
          label="Guardar"
          size="small"
          icon="pi pi-check"
          (click)="onCreateIndicator()"
          [outlined]="true"
          severity="success"
          [disabled]="formGroup.invalid"
        />
      </footer>
    </form>
  </p-dialog>
  <p-dialog
    header="Editar Indicador"
    [modal]="true"
    [(visible)]="visibleEditIndicator"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '30rem' }"
    (onHide)="closeDialogIndicator()"
  >
    <form [formGroup]="formGroup">
      <div class="flex flex-column gap-3">
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Índice
            <input
              pInputText
              name="index"
              class="w-full"
              type="number"
              formControlName="index"
              (input)="errorsUpdate('index')"
              (blur)="errorsUpdate('index')"
            />
          </label>
          <small class="p-error">{{ errors.index }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Nombre
            <input
              pInputText
              name="name"
              class="w-full"
              type="text"
              formControlName="name"
              (input)="errorsUpdate('name')"
              (blur)="errorsUpdate('name')"
            />
          </label>
          <small class="p-error">{{ errors.name }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Alias en español
            <input
              pInputText
              name="alias"
              class="w-full"
              type="text"
              formControlName="alias"
              (input)="errorsUpdate('alias')"
              (blur)="errorsUpdate('alias')"
            />
          </label>
          <small class="p-error">{{ errors.alias }}</small>
        </div>
        <div class="flex flex-column gap-2 w-full">
          <label class="flex flex-column gap-2 w-full">
            Texto de ayuda
            <textarea
              pInputTextarea
              rows="5"
              cols="40"
              formControlName="helpText"
              (input)="errorsUpdate('helpText')"
              (blur)="errorsUpdate('helpText')"
            ></textarea>
          </label>
          <small class="p-error">{{ errors.helpText }}</small>
        </div>
      </div>
      <footer class="flex justify-content-end gap-2 mt-4">
        <p-button
          label="Cancelar"
          size="small"
          icon="pi pi-times"
          [outlined]="true"
          severity="danger"
          (click)="visibleEditIndicator = false"
        />
        <p-button
          label="Guardar"
          size="small"
          icon="pi pi-check"
          (click)="onEditIndicator()"
          [outlined]="true"
          severity="success"
          [disabled]="formGroup.invalid"
        />
      </footer>
    </form>
  </p-dialog>
  <p-confirmDialog />
</main>
